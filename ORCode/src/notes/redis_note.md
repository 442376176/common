# Redis事务

Redis事务是一个单独的隔离操作：事务中的所有命令都会序列化、按顺序地执行。事务在执行过程中，不会被其他客户端发送来的命令打断。

Redis事务的主要作用就是 **串联多个命令**防止别的命令插队



### Multi、Exec、discard

从输入Multi命令开始，输入的命令都会一次进入命令队列，但不会执行，直到输入Exec后，Redis会将之前的命令队列中的命令依次执行。

组队的过程中可以使用discard来放弃组队

![image-20210812095858362](C:\Users\86151\Desktop\image-20210812095858362.png)

![image-20210812095609654](C:\Users\86151\AppData\Roaming\Typora\typora-user-images\image-20210812095609654.png)

### 事务的错误处理

**组队阶段**：某个命令出现了报告错误，执行时整个的队列的所有命令都会被取消

**执行阶段**：某个命令执行出错，只有报错的命令不被执行，而其他的命令都会正常执行，不会回滚。



### 事务的冲突问题

#### 锁

##### 悲观锁：

操作之前先加锁，结束之后释放锁。传统的关系型数据库里边就用到了很多这种锁机制，比如航所，表锁等，读锁，写锁等都是在操作之前先上锁

###### 乐观锁：

操作时修改版本号，检查当前数据的版本号与数据库中的版本号是否一致，版本号不一致不可操作

乐观锁适用于多读的应用类型，这样可以提高吞吐量。Redis就是利用这种check-and-set机制实现事务的。



乐观锁的使用

watch key 【key...】

在执行multi之前，先执行watch key1 【key2...】可以监视一个（或多个）key，如果在事务**执行之前这个（这些）key被其他命令所改动，那么事务将被打断**

## Redis事务三特性

### 1.单独的隔离操作

​	事务中的所有命令都会序列化、按顺序执行。事务在执行的过程中，不会被其他客户端发来的命令请求所打断。

### 2.没有隔离级别的概念

​	队列中的命令没有提交之前都不会实际被执行，因为事务提交前任何指令都不会被实际执行。

### 3.不保证原子性

​	事务中如果有一条命令执行失败，气候的命令仍然会被执行，没有回滚。





### 乐观锁造成 库存遗留问题：

版本号不一致导致并发进程无法购买

解决：使用LUA脚本

LUA脚本在Redis中的优势：

1.将复杂的或多步的redis操作，写为一个脚本，一次提交给redis执行，减少反复连接redis的次数，提升性能。

2.LUA脚本是类似reids事务，有一定的原子性，不会被其他命令插队，可以完成一些redis事务性的操作。

3.但是注意redis的lua脚本功能，只有在Redis2.6以上的版本才能使用

redis2.6版本以后，通过lua脚本解决争抢问题，实际上是redis利用其单线程的特性，用任务队列的方式解决多任务并发问题。

